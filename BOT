import discord
from discord.ext import commands
from mcstatus import JavaServer
import asyncio
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
import time

# ğŸ”‘ KONFIGURACJA
TOKEN = ""
MC_SERVER_IP = ""
MC_SERVER_PORT = 
CHANNEL_ID = 8  # ID kanaÅ‚u na Discordzie

# ğŸ”‘ DANE LOGOWANIA DO ATERNOS (zmieÅ„ na swoje!)
ATERNOS_LOGIN = ""
ATERNOS_PASSWORD = ""

# ğŸ® INICJALIZACJA BOTA
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# ğŸŸ¢ KOMENDA !status â€“ Sprawdza status serwera
@bot.command()
async def status(ctx):
    try:
        server = JavaServer.lookup(f"{MC_SERVER_IP}:{MC_SERVER_PORT}")
        status = server.status()

        player_names = ", ".join(player.name for player in status.players.sample) if status.players.sample else "Brak graczy online"

        embed = discord.Embed(
            title=f"ğŸ® **Status serwera: {MC_SERVER_IP}**",
            description="PoniÅ¼ej szczegÃ³Å‚y na temat serwera Minecraft.",
            color=discord.Color.blue()
        )
        embed.set_thumbnail(url="https://i.imgur.com/IkN2wWn.png")  # Tutaj dodajemy ikonÄ™ (zmieÅ„ link, jeÅ›li chcesz inny)
        embed.add_field(name="ğŸ“Š Gracze online", value=f"{status.players.online}/{status.players.max}", inline=False)
        embed.add_field(name="ğŸ‘¥ Lista graczy", value=player_names, inline=False)
        embed.add_field(name="ğŸ“¶ Ping", value=f"{status.latency} ms", inline=False)
        embed.set_footer(text="Bot Minecraft Status | mcstatus API", icon_url="https://i.imgur.com/IkN2wWn.png")

        await ctx.send(embed=embed)
    except Exception as e:
        await ctx.send("âŒ **Nie udaÅ‚o siÄ™ pobraÄ‡ statusu serwera!**")
        print(f"ğŸ”´ BÅ‚Ä…d: {e}")

# ğŸ”„ KOMENDA !gracze â€“ Liczba graczy i ich nazwy
@bot.command()
async def gracze(ctx):
    try:
        server = JavaServer.lookup(f"{MC_SERVER_IP}:{MC_SERVER_PORT}")
        status = server.status()

        player_count = status.players.online
        player_list = "\n".join(player.name for player in status.players.sample) if status.players.sample else "Brak graczy online"

        embed = discord.Embed(
            title="ğŸ‘¥ **Gracze online**",
            description=f"Obecnie na serwerze {MC_SERVER_IP} znajdujÄ… siÄ™ nastÄ™pujÄ…cy gracze:",
            color=discord.Color.green()
        )
        embed.set_thumbnail(url="https://i.imgur.com/IkN2wWn.png")  # Dodanie ikony
        embed.add_field(name="ğŸ“Š Liczba graczy", value=str(player_count), inline=False)
        embed.add_field(name="ğŸ‘¥ Lista graczy", value=player_list, inline=False)
        embed.add_field(name="ğŸ“Œ IP serwera", value=MC_SERVER_IP, inline=False)

        await ctx.send(embed=embed)
    except Exception as e:
        await ctx.send("âŒ **Nie udaÅ‚o siÄ™ pobraÄ‡ listy graczy!**")
        print(f"ğŸ”´ BÅ‚Ä…d: {e}")

# ğŸ”” KOMENDA !ping â€“ OpÃ³Åºnienie bota
@bot.command()
async def ping(ctx):
    latency = round(bot.latency * 1000)  # Konwersja na ms
    embed = discord.Embed(
        title="ğŸ“ **Pong!**",
        description=f"OpÃ³Åºnienie bota wynosi `{latency} ms`",
        color=discord.Color.purple()
    )
    embed.set_footer(text="Sprawdzanie opÃ³Åºnienia bota")
    await ctx.send(embed=embed)

# ğŸ”„ KOMENDA !start â€“ Uruchamianie serwera na Aternos
@bot.command()
async def start(ctx):
    await ctx.send("ğŸŸ¢ PrÃ³ba uruchomienia serwera na Aternos...")

    try:
        options = webdriver.ChromeOptions()
        options.add_argument("--headless")  # Tryb bez GUI
        driver = webdriver.Chrome(options=options)

        driver.get("https://aternos.org/go/")
        time.sleep(3)

        # Logowanie
        driver.find_element(By.NAME, "user").send_keys(ATERNOS_LOGIN)
        driver.find_element(By.NAME, "password").send_keys(ATERNOS_PASSWORD, Keys.RETURN)
        time.sleep(5)

        driver.get("https://aternos.org/server/")
        time.sleep(3)

        # KlikniÄ™cie "Start"
        start_button = driver.find_element(By.XPATH, "//button[contains(text(), 'Start')]")
        start_button.click()

        await ctx.send("âœ… **Serwer jest uruchamiany!** MoÅ¼e to potrwaÄ‡ kilka minut...")
        driver.quit()

    except Exception as e:
        await ctx.send("âŒ **Nie udaÅ‚o siÄ™ uruchomiÄ‡ serwera!**")
        print(f"ğŸ”´ BÅ‚Ä…d: {e}")

# ğŸ”„ AUTOMATYCZNE SPRAWDZANIE SERWERA
server_was_online = False
last_players = set()

async def check_server_status():
    global server_was_online, last_players
    await bot.wait_until_ready()
    channel = bot.get_channel(CHANNEL_ID)

    while not bot.is_closed():
        try:
            server = JavaServer.lookup(f"{MC_SERVER_IP}:{MC_SERVER_PORT}")
            status = server.status()

            # ğŸ”” Powiadomienie, jeÅ›li serwer siÄ™ wÅ‚Ä…czyÅ‚
            if not server_was_online:
                embed = discord.Embed(
                    title="ğŸŸ¢ **Serwer jest ONLINE!** ğŸ‰",
                    description="Serwer Minecraft jest teraz dostÄ™pny.",
                    color=discord.Color.green()
                )
                embed.set_thumbnail(url="https://i.imgur.com/IkN2wWn.png")
                await channel.send(embed=embed)
                server_was_online = True  

            # ğŸ‘¥ Sprawdzanie listy graczy
            current_players = {p.name for p in status.players.sample} if status.players.sample else set()
            new_players = current_players - last_players
            for player in new_players:
                embed = discord.Embed(
                    title=f"ğŸ‘‹ **{player} doÅ‚Ä…czyÅ‚ do serwera!**",
                    description="Nowy gracz doÅ‚Ä…czyÅ‚ do zabawy!",
                    color=discord.Color.orange()
                )
                embed.set_thumbnail(url="https://i.imgur.com/IkN2wWn.png")
                await channel.send(embed=embed)

            last_players = current_players

        except:
            # ğŸ”´ Powiadomienie, jeÅ›li serwer siÄ™ wyÅ‚Ä…czyÅ‚
            if server_was_online:
                embed = discord.Embed(
                    title="ğŸ”´ **Serwer jest OFFLINE!** ğŸš¨",
                    description="Serwer Minecraft jest wyÅ‚Ä…czony.",
                    color=discord.Color.red()
                )
                embed.set_thumbnail(url="https://i.imgur.com/IkN2wWn.png")
                await channel.send(embed=embed)
                server_was_online = False

        await asyncio.sleep(300)  # Sprawdzanie co 5 minut

# ğŸ”¥ URUCHOMIENIE BOTA
@bot.event
async def on_ready():
    print(f"âœ… Bot zalogowany jako {bot.user}")
    bot.loop.create_task(check_server_status())

bot.run(TOKEN)
